import telebot
from telebot import types

# Ваш токен Telegram API
TOKEN = "8100213011:AAFSoqbfRn8OatYW6CFo8B1r3EpQr1QilY0"

bot = telebot.TeleBot(TOKEN)

# Хранилище для продуктов и состояния пользователей
user_products = {}
user_states = {}

# Команда /start
@bot.message_handler(commands=['start'])
def start(message):
    user_id = message.chat.id
    user_products[user_id] = []  # Инициализация пустого списка продуктов для пользователя
    
    # Создание клавиатуры с кнопками для команд
    markup = types.ReplyKeyboardMarkup(resize_keyboard=True)
    markup.add(
        types.KeyboardButton("Добавить продукт"),
        types.KeyboardButton("Список продуктов"),
        types.KeyboardButton("Получить рецепт"),
        types.KeyboardButton("Удалить все продукты")
    )

    bot.send_message(user_id, 
        "Привет! Я кулинарный бот, который поможет тебе управлять списком продуктов и находить рецепты.\n"
        "Выбери нужную команду с помощью кнопок ниже.", 
        reply_markup=markup
    )

# Обработчик для кнопок
@bot.message_handler(func=lambda message: message.text in ["Добавить продукт", "Список продуктов", "Получить рецепт", "Удалить все продукты"])
def handle_buttons(message):
    user_id = message.chat.id
    text = message.text.lower()

    if text == "добавить продукт":
        user_states[user_id] = 'adding_product'
        bot.send_message(user_id, "Напишите название продукта, чтобы добавить его в список.")
    elif text == "список продуктов":
        list_products(message)
    elif text == "получить рецепт":
        get_recipes(message)
    elif text == "удалить все продукты":
        remove_all_products(message)

# Обработчик для добавления продукта после нажатия кнопки "Добавить продукт"
@bot.message_handler(func=lambda message: user_states.get(message.chat.id) == 'adding_product')
def add_product(message):
    user_id = message.chat.id
    product_name = message.text.lower()

    if user_id not in user_products:
        user_products[user_id] = []
    user_products[user_id].append(product_name)
    user_states[user_id] = None  # Сбрасываем состояние после добавления
    bot.send_message(user_id, f"Продукт '{product_name}' добавлен.")

# Команда для показа списка продуктов
def list_products(message):
    user_id = message.chat.id
    products = user_products.get(user_id, [])
    
    if products:
        bot.send_message(user_id, "Ваши продукты:\n" + "\n".join(products))
    else:
        bot.send_message(user_id, "Ваш список продуктов пуст.")

# Команда для удаления всех продуктов
def remove_all_products(message):
    user_id = message.chat.id
    if user_id in user_products:
        user_products[user_id].clear()  # Очищаем весь список продуктов
        bot.send_message(user_id, "Все продукты удалены.")
    else:
        bot.send_message(user_id, "Ваш список продуктов уже пуст.")

# База данных с рецептами
recipes = {
    frozenset(["яйца", "молоко", "масло"]): (
        "Рецепт яичного омлета:\n\n"
        "- Яйца — 3 шт.\n"
        "- Молоко — 2 столовые ложки\n"
        "- Соль и перец по вкусу\n"
        "- Масло для жарки\n\n"
        "1. Взбейте яйца с молоком, добавьте соль и перец.\n"
        "2. Разогрейте сковороду с маслом и вылейте смесь.\n"
        "3. Готовьте, пока омлет не станет золотистым. Приятного аппетита!"
    ),
    frozenset(["помидоры", "огурцы", "перец", "маслины", "фета", "оливковое масло", "лук"]): (
    "Рецепт Греческого салата:\n\n"
    "- Помидоры — 2 шт.\n"
    "- Огурцы — 1 шт.\n"
    "- Сладкий перец — 1 шт.\n"
    "- Маслины — 10–15 шт.\n"
    "- Сыр фета — 150 г\n"
    "- Лук красный — 1/2 шт.\n"
    "- Оливковое масло — 3 ст.л.\n"
    "- Соль, орегано — по вкусу\n\n"
    "1. Нарежьте помидоры крупными дольками, огурцы — полукольцами, сладкий перец — полосками.\n"
    "2. Лук нарежьте тонкими кольцами.\n"
    "3. Выложите овощи в миску, добавьте маслины и нарезанный кубиками сыр фета.\n"
    "4. Заправьте салат оливковым маслом, добавьте соль и орегано по вкусу.\n"
    "5. Аккуратно перемешайте и подавайте. Приятного аппетита!"
    ),
    frozenset(["яйца", "молоко", "масло", "сыр"]): (
        "Рецепт Чезабреты:\n\n"
        "- Мука — 300 г\n"
        "- Тертый сыр (чеддер или гауда) — 150 г\n"
        "- Яйцо — 1 шт.\n"
        "- Сметана — 100 мл\n"
        "- Разрыхлитель — 1 ч.л.\n"
        "- Соль — по вкусу\n"
        "- Масло для жарки\n\n"
        "1. В миске смешайте муку, соль, разрыхлитель и тертый сыр.\n"
        "2. Добавьте яйцо и сметану, замесите мягкое тесто.\n"
        "3. Разделите тесто на кусочки, раскатайте в лепешки.\n"
        "4. Разогрейте сковороду с маслом, обжаривайте лепешки до золотистой корочки с двух сторон.\n"
        "5. Подавайте горячими с любимым соусом. Приятного аппетита!"
    ),
    frozenset(["картофель", "лук", "морковь", "говядина", "томаты", "специи", "вода"]): (
        "Рецепт Борща:\n\n"
        "- Картофель — 3 шт.\n"
        "- Лук — 1 шт.\n"
        "- Морковь — 1 шт.\n"
        "- Говядина — 500 г\n"
        "- Томаты — 2 шт. или томатная паста — 2 ст.л.\n"
        "- Вода — 2 л\n"
        "- Специи: соль, перец, лавровый лист — по вкусу\n\n"
        "1. Отварите говядину, добавьте нарезанный картофель.\n"
        "2. Обжарьте лук, морковь и томаты, добавьте в бульон.\n"
        "3. Приправьте специями, варите до готовности.\n"
        "4. Подавайте со сметаной и зеленью. Приятного аппетита!"
    ),
    frozenset(["спагетти", "фарш", "томатный соус", "лук", "чеснок", "специи"]): (
        "Рецепт Спагетти Болоньезе:\n\n"
        "- Спагетти — 300 г\n"
        "- Фарш (говядина или свинина) — 400 г\n"
        "- Томатный соус — 200 мл\n"
        "- Лук — 1 шт.\n"
        "- Чеснок — 2 зубчика\n"
        "- Специи: соль, перец, орегано — по вкусу\n\n"
        "1. Отварите спагетти до готовности.\n"
        "2. Обжарьте лук и чеснок, добавьте фарш, готовьте до румяной корочки.\n"
        "3. Добавьте томатный соус и специи, тушите 10 минут.\n"
        "4. Подавайте спагетти с мясным соусом. Приятного аппетита!"
    ),
    frozenset(["рис", "курица", "морковь", "лук", "специи", "вода"]): (
        "Рецепт Плова:\n\n"
        "- Рис — 2 стакана\n"
        "- Курица — 500 г\n"
        "- Морковь — 2 шт.\n"
        "- Лук — 1 шт.\n"
        "- Вода — 4 стакана\n"
        "- Специи: соль, перец, зира — по вкусу\n\n"
        "1. Обжарьте лук и морковь, добавьте кусочки курицы.\n"
        "2. Промойте рис, выложите сверху, залейте водой.\n"
        "3. Добавьте специи, готовьте под крышкой до впитывания воды.\n"
        "4. Подавайте горячим. Приятного аппетита!"
    ),
    frozenset(["мука", "яйцо", "молоко", "сахар", "соль", "масло"]): (
        "Рецепт Блинов:\n\n"
        "- Мука — 200 г\n"
        "- Яйцо — 2 шт.\n"
        "- Молоко — 500 мл\n"
        "- Сахар — 1 ст.л.\n"
        "- Соль — щепотка\n"
        "- Масло растительное — 2 ст.л.\n\n"
        "1. Смешайте все ингредиенты до однородной массы.\n"
        "2. Выпекайте блины на горячей сковороде с двух сторон.\n"
        "3. Подавайте с вареньем, медом или сметаной. Приятного аппетита!"
    ),
    frozenset(["рыба", "лимон", "соль", "перец", "оливковое масло"]): (
        "Рецепт Запечённой рыбы:\n\n"
        "- Рыба (например, форель) — 1 шт.\n"
        "- Лимон — 1 шт.\n"
        "- Соль, перец — по вкусу\n"
        "- Оливковое масло — 2 ст.л.\n\n"
        "1. Натрите рыбу солью и перцем, сбрызните лимонным соком.\n"
        "2. Выложите рыбу на противень, смажьте маслом.\n"
        "3. Запекайте при 180°C в течение 25 минут.\n"
        "4. Подавайте с овощами. Приятного аппетита!"
    ),
    frozenset(["хлеб", "сыр", "ветчина", "масло"]): (
        "Рецепт Горячих бутербродов:\n\n"
        "- Хлеб — 4 ломтика\n"
        "- Сыр — 100 г\n"
        "- Ветчина — 100 г\n"
        "- Масло сливочное — 20 г\n\n"
        "1. Намажьте хлеб маслом, выложите на него сыр и ветчину.\n"
        "2. Запекайте в духовке при 200°C до расплавления сыра.\n"
        "3. Подавайте горячими. Приятного аппетита!"
    ),
    frozenset(["капуста", "морковь", "лук", "фарш", "рис", "томатный соус", "специи"]): (
        "Рецепт Голубцов:\n\n"
        "- Капуста — 1 качан\n"
        "- Морковь — 1 шт.\n"
        "- Лук — 1 шт.\n"
        "- Фарш — 500 г\n"
        "- Рис — 1 стакан\n"
        "- Томатный соус — 200 мл\n"
        "- Специи: соль, перец — по вкусу\n\n"
        "1. Отварите капустные листья, приготовьте начинку из фарша, риса и специй.\n"
        "2. Заверните начинку в листья, выложите в кастрюлю.\n"
        "3. Залейте томатным соусом, тушите 40 минут.\n"
        "4. Подавайте горячими. Приятного аппетита!"
    ),
    frozenset(["тесто", "сыр", "томатный соус", "помидоры", "колбаса", "оливки"]): (
        "Рецепт Пиццы:\n\n"
        "- Тесто — 1 основа\n"
        "- Сыр — 200 г\n"
        "- Томатный соус — 3 ст.л.\n"
        "- Помидоры — 1 шт.\n"
        "- Колбаса — 100 г\n"
        "- Оливки — 10 шт.\n\n"
        "1. Раскатайте тесто, смажьте томатным соусом.\n"
        "2. Выложите нарезанные ингредиенты, посыпьте сыром.\n"
        "3. Выпекайте при 200°C 15–20 минут.\n"
        "4. Подавайте горячей. Приятного аппетита!"
    ),
    frozenset(["яйца", "молоко", "сахар", "ваниль", "хлеб"]): (
        "Рецепт Гренок:\n\n"
        "- Яйца — 2 шт.\n"
        "- Молоко — 100 мл\n"
        "- Сахар — 2 ст.л.\n"
        "- Ваниль — щепотка\n"
        "- Хлеб — 6 ломтиков\n\n"
        "1. Смешайте яйца, молоко, сахар и ваниль.\n"
        "2. Обмакните хлеб в смесь, обжарьте на сковороде с двух сторон.\n"
        "3. Подавайте с вареньем или сахарной пудрой. Приятного аппетита!"
    ),
    frozenset(["курица", "чеснок", "сметана", "специи"]): (
        "Рецепт Курицы в сметане:\n\n"
        "- Курица — 1 кг\n"
        "- Чеснок — 2 зубчика\n"
        "- Сметана — 200 мл\n"
        "- Специи: соль, перец — по вкусу\n\n"
        "1. Нарежьте курицу на кусочки, натрите специями и чесноком.\n"
        "2. Обжарьте на сковороде, добавьте сметану, тушите 20 минут.\n"
        "3. Подавайте с гарниром. Приятного аппетита!"
    )
    
}

    


# Команда для поиска рецептов на основе продуктов (частичное совпадение)
def get_recipes(message):
    user_id = message.chat.id
    products = set(user_products.get(user_id, []))  # Продукты пользователя как множество

    # Порог минимального совпадения
    min_matches = 3

    # Список найденных рецептов
    found_recipes = []

    for ingredients, recipe in recipes.items():
        # Подсчет совпадающих ингредиентов
        matches = len(ingredients & products)  # Пересечение множеств
        if matches >= min_matches:
            found_recipes.append((matches, recipe))

    # Если найдены рецепты, отправляем их пользователю, отсортированные по количеству совпадений
    if found_recipes:
        found_recipes.sort(reverse=True, key=lambda x: x[0])  # Сортировка по количеству совпадений
        for _, recipe in found_recipes:
            bot.send_message(user_id, recipe)
    else:
        bot.send_message(user_id, "На основе ваших продуктов пока нет подходящих рецептов. Ждите апдейта.")

    


# Запуск бота
bot.polling()
